# **Webアプリケーションとモバイルアプリの分離構成とマイクロサービスの活用**

## **1. Webアプリとモバイルアプリの分離構成の利点**

Webアプリケーションとモバイルアプリケーションを別々のシステムとして設計することには、以下のような利点があります。

### **1.1. UI/UX の最適化**
- Webアプリとモバイルアプリでは、UI/UX の要件が異なるため、個別に最適化できる。
- Webはデスクトップ画面向けのデザイン、モバイルはタッチ操作に最適化したデザインを実装可能。

### **1.2. パフォーマンスとスケーラビリティ**
- Webアプリとモバイルアプリのトラフィック特性が異なるため、それぞれに適した最適化が可能。
- モバイルはAPIリクエストの効率化（バッチ処理やキャッシュ活用）を考慮しやすい。

### **1.3. 独立した開発・デプロイ**
- Webアプリとモバイルアプリを別々のチームが並行開発できる。
- 個別の技術スタック（例: WebはReact、モバイルはFlutterやSwift/Android）を採用可能。

### **1.4. セキュリティと認証の分離**
- Webアプリはセッションベース、モバイルアプリはトークンベースの認証を採用できる。
- 各プラットフォームに適したセキュリティ対策を実装可能。

## **2. API Gateway による認証とマイクロサービスの連携**

Webアプリ用とモバイルアプリ用の API Gateway で認証処理を行い、認証済みのユーザー情報を基にマイクロサービスへ処理を委譲する構成を採用します。

### **2.1. アーキテクチャ構成**

```mermaid
graph TD;
    A[Webアプリ] -->|リクエスト| B[Web API Gateway<br>（セッション認証処理）]
    C[モバイルアプリ] -->|リクエスト| D[Mobile API Gateway<br>（トークン認証処理）]

    B -->|利用| E[認証情報管理]
    D -->|利用| E[認証情報管理]

    B -->|認証済みリクエスト| F[アプリケーションサービス<br>（アプリケーションユースケースの実行）]
    D -->|認証済みリクエスト| F

    F -->|利用| G[ユーザー情報管理サービス]
    F -->|利用| H[コンテンツ管理]
    F -->|利用| I[支払いサービス]
    F -->|利用| J[ログ管理]

    subgraph API Gateway
        B
        D
        E
    end

    subgraph マイクロサービス
        G
        H
        I
        J
    end

    subgraph アプリケーション
        F
    end
```

## **2.2. 各コンポーネントの役割**

| **コンポーネント**         | **役割** |
|----------------|------------------------------------------------|
| **Webアプリ** | セッションベースの認証を使用し、HTML/JSを提供 |
| **モバイルアプリ** | トークンベースの認証を使用し、APIを活用 |
| **Web API Gateway** | セッション認証を実施し、認証済みリクエストをマイクロサービスへ委譲 |
| **Mobile API Gateway** | トークン認証を実施し、認証済みリクエストをマイクロサービスへ委譲 |
| **認証情報管理サービス** | OIDC, JWT を使用し、ユーザーを認証しトークンを発行 |
| **アプリケーションサービス** | アプリケーションユースケースの実行 |
| **ユーザー情報管理サービス** | ユーザープロフィールや設定の管理 |
| **コンテンツ管理サービス** | アプリ内のコンテンツを管理、提供 |
| **支払いサービス** | 支払い処理やサブスクリプション管理を提供 |
| **ログ管理サービス** | システム全体のログを収集・分析 |

---

## **3. API Gateway による認証のメリット**

### **3.1. 認証の一元化**
- Web API Gateway ではセッション、Mobile API Gateway ではトークンを使用して認証を統一。
- 認証処理を API Gateway に集約することで、マイクロサービス側の認証負荷を削減。

### **3.2. スケーラビリティ**
- Web API Gateway・Mobile API Gateway を分離することで、各プラットフォームに最適化可能。
- 認証サービスを独立させることで、負荷が高い認証処理をスケール可能。

### **3.3. セキュリティの強化**
- API Gateway で認証済みユーザーのみをマイクロサービスに通すことで、不正アクセスを防止。
- JWT による認証を採用することで、トークンの有効期限やスコープを制御可能。

### **3.4. 柔軟な技術選択**
- フロントエンドは React, Vue.js, Flutter, Swift, Kotlin など用途に応じて選択可能。
- バックエンドは Node.js, Rails, Go, Java, Python など、サービスごとに適した技術を採用可能。

---

## **4. まとめ**

| **項目**            | **Webとモバイルの分離**       | **API Gateway による認証と委譲** |
|--------------------|--------------------|----------------------|
| **開発の独立性**     | Webとモバイルの開発を独立して進められる | 認証処理を一元化しつつ、各マイクロサービスへ委譲 |
| **UI/UXの最適化**   | Webとモバイルで異なるデザイン・UXを提供 | 各プラットフォームに適したデータ形式を提供可能 |
| **スケーラビリティ** | Webとモバイルの負荷を分けて管理可能 | API Gateway 単位でスケール可能 |
| **認証の管理**       | Web: セッション, モバイル: トークン | API Gateway で認証を統一し、マイクロサービスへ委譲 |
| **セキュリティ**     | 各フロントエンドで適切な認証方式を採用 | API Gateway によるアクセス制御でセキュリティ強化 |

この構成を採用することで、**Webアプリとモバイルアプリの開発を効率化しつつ、共通のバックエンドを活用しながら最適な認証・データ提供を実現する** ことができます。

# 認証済みリクエストの想定仕様

本アーキテクチャでは、Webアプリおよびモバイルアプリからのリクエスト時に適切な認証情報を付与し、API Gateway を通じて認証処理を行います。その後、認証済みリクエストとしてアプリケーションサービスに渡されます。

## **1. 認証情報の付与**

### **(1) Webアプリからのリクエスト**
- **認証方式:** セッションベース認証
- **リクエストヘッダー/形式:**
  - `Cookie: session_id=<セッションID>` (Secure & HttpOnly)

#### **リクエスト例**
```http
GET /user/profile HTTP/1.1
Host: api.example.com
Cookie: session_id=abc123;
```

### **(2) モバイルアプリからのリクエスト**
- **認証方式:** トークンベース認証（JWT, OIDC）
- **リクエストヘッダー/形式:**
  - `Authorization: Bearer <JWT>`

#### **リクエスト例**
```http
GET /user/profile HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5...
```

## **2. 認証情報管理とAPI Gatewayの役割**

### **(1) 認証情報管理サービス**
- ユーザーの認証情報（セッションIDまたはトークン）の検証を行う
- API Gateway からのリクエストを受け付け、認証情報が有効かを確認する
- 認証情報が無効な場合、`401 Unauthorized` を返す

### **(2) API Gateway における処理**
| API Gateway            | 認証方式                         | 認証情報の検証 | 認証情報の付与 |
|------------------------|--------------------------------|--------------|--------------|
| **Web API Gateway**    | セッションベース認証           | 認証情報管理サービスで検証 | `X-Authenticated-User` ヘッダーにユーザー情報を付与 |
| **Mobile API Gateway** | トークンベース認証（JWT, OIDC） | 認証情報管理サービスで検証 | `X-Authenticated-User` ヘッダーにユーザー情報を付与 |

## **3. 認証済みリクエストの構成**
認証後、API Gateway はリクエストに **ユーザー識別情報（認証済み情報）** を含めてアプリケーションサービスへ転送します。

### **(1) Web API Gateway → アプリケーションサービス**
```http
GET /user/profile HTTP/1.1
Host: api.example.com
X-Authenticated-User: 12345
X-Authenticated-Scopes: read_profile, edit_profile
```

### **(2) Mobile API Gateway → アプリケーションサービス**
```http
GET /user/profile HTTP/1.1
Host: api.example.com
X-Authenticated-User: 12345
X-Authenticated-Scopes: read_profile, edit_profile
```

## **4. JWT トークンの構成**

Mobile API Gateway では JWT 認証を行い、以下のようなトークンを利用します。

### (1) ヘッダー
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

### (2) ペイロード
```json
{
  "sub": "12345",
  "name": "John Doe",
  "email": "john.doe@example.com",
  "iat": 1712345678,
  "exp": 1712355678,
  "scope": ["read_profile", "edit_profile"]
}
```

- `sub`: ユーザーID（12345）
- `email`: ユーザーのメールアドレス
- `iat`: トークン発行日時
- `exp`: トークン有効期限
- `scope`: 許可されたスコープ（権限）

---

## 4. API Gateway の役割

- **Web API Gateway**
  - Cookie セッションを管理
  - 認証済みユーザー情報を `X-Authenticated-User` ヘッダーに追加
  - セッションが無効な場合、401 Unauthorized を返す

- **Mobile API Gateway**
  - `Authorization: Bearer <JWT>` の検証
  - JWT からユーザー情報を抽出し `X-Authenticated-User` ヘッダーに追加
  - JWT が無効な場合、401 Unauthorized を返す

---

## 5. 認証済みリクエストのメリット

✅ **アプリケーションサービスは認証処理を意識せずにリクエストを処理できる**  
✅ **Web API と Mobile API で異なる認証方式を統一した形で扱える**  
✅ **マイクロサービスが直接認証情報を確認せずに API Gateway を通じたアクセス制御が可能**  
✅ **スコープ管理により、細かい権限分割が可能**  

この構成により、認証情報が適切に管理され、Web アプリ・モバイルアプリともに統一された認証済みリクエスト形式を提供できます。

