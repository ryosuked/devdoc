# **Ruby on Rails API開発: ネイティブアプリ向けバックエンド構築手順**

## **1. 要件定義と環境構築（Docker + MySQL + Redis）**  

### **1.1 要件定義**  
#### **機能要件**  
- ユーザー認証（ログイン・ログアウト・新規登録）  
- CRUD操作（例：投稿・コメント）  
- バックグラウンドジョブ（メール通知、非同期処理）  
- APIレスポンスの最適化（ページネーション、キャッシュ）  

#### **非機能要件**  
- **パフォーマンス**：リクエスト処理速度、レスポンス時間の制約  
- **スケーラビリティ**：負荷分散対応、データベース設計  
- **セキュリティ**：JWT認証、CORS対策、SQLインジェクション防止  

### **1.2 開発環境の構築**  
- **Ruby on Railsのバージョン決定**（最新の安定版）  
- **データベース**：MySQL（永続化の設定、適切なインデックス設計）  
- **キャッシュ**：Redis（セッション管理、ジョブ管理に利用）  
- **Docker構成**  
  - `Dockerfile` の作成（Railsアプリのコンテナ化）  
  - `docker-compose.yml` にデータベース、Redisの設定  
  - **環境変数の管理**（`dotenv` や `Rails.credentials`）  

---

## **2. Rails APIモードで構築（認証・リソース設計）**  

### **2.1 Rails APIモードの特徴**  
- **ビューを持たない**（JSONレスポンスのみ）  
- **軽量化**（不要なミドルウェアが読み込まれない）  
- **CORS対策が必要**（ブラウザ・モバイルアプリ対応）  

### **2.2 認証機能の設計**  
- **ユーザー登録**（メールアドレス + パスワード）  
- **トークンベースの認証**（JWTを使用）  
- **認証の有効期限とリフレッシュトークンの実装**  

### **2.3 リソース設計**  
- **エンドポイントの設計**（RESTful APIの設計）  
- **ネストされたリソースの定義**（例：`/users/:id/posts`）  
- **バージョン管理（`/api/v1/...`）**  
- **リクエストとレスポンスのフォーマット設計**（JSON形式の統一）  

---

## **3. JWT認証の導入（Devise + JWT）**  

### **3.1 Deviseのセットアップ**  
- **ユーザーモデルの作成**（`email`、`password_digest` など）  
- **Deviseの設定変更**（`jwt_authenticatable` を有効化）  
- **リクエストヘッダーにJWTを含める設計**  

### **3.2 JWTトークンの発行・管理**  
- **トークンの発行**（ログイン時にJWTを生成）  
- **トークンの検証**（リクエストごとに検証）  
- **リフレッシュトークンの導入**（再ログイン不要にするため）  

### **3.3 セキュリティ対策**  
- **トークンの有効期限の設定**（短めの期限 + リフレッシュトークン）  
- **ログアウト時のトークン無効化**  
- **Redisを使ったトークンブラックリスト管理**  

---

## **4. データベース設計とマイグレーション**  

### **4.1 データモデリング**  
- **エンティティの洗い出し**（ユーザー、投稿、コメントなど）  
- **リレーションの設計**（`has_many`、`belongs_to`）  
- **ポリモーフィック関連の活用**（柔軟なデータ構造）  
- **STI（Single Table Inheritance）の適用**（共通カラムを持つ場合）  

### **4.2 マイグレーション戦略**  
- **デフォルト値の設定**（`default: false` など）  
- **カラムの制約**（`null: false`、`unique: true`）  
- **インデックスの最適化**（`add_index` の活用）  

---

## **5. クリーンアーキテクチャをRailsに適用した場合の構成**  

### **5.1 レイヤー分割**  
- **コントローラー層**（HTTPリクエストの受け取り、認証処理）  
- **ユースケース層（Interactor）**（ビジネスロジックの実装）  
- **リポジトリ層**（データベースへのアクセス処理）  
- **エンティティ層**（ドメインモデルの定義）  

---

## **6. APIエンドポイントの実装 < Jbuilderを利用しない方法**  

### **6.1 シリアライザーを利用**  
- **ActiveModel::Serializer の活用**  
- **Fast JSON API の導入**  

### **6.2 JSONレスポンスの最適化**  
- **レスポンスデータのカスタマイズ**  
- **ネストされたリソースの効率的な取得**  

---

## **7. CORS設定（ネイティブアプリと連携）**  

### **7.1 必要なCORS設定**  
- **リクエストを許可するドメインの制限**  
- **HTTPメソッドの許可（`GET`, `POST`, `PUT`, `DELETE`）**  
- **ヘッダーの許可設定（`Authorization` ヘッダーを含める）**  

### **7.2 セキュリティ対策**  
- **本番環境では許可するオリジンを制限**  
- **プリフライトリクエストの最適化**  

---

## **8. APIテストの実施（RSpec）**  

### **8.1 テスト対象**  
- **リクエストのレスポンスコードが正しいか**  
- **認証が必要なAPIが適切に動作するか**  

### **8.2 テストデータの準備**  
- **FactoryBot の活用**  
- **Faker でダミーデータを生成**  
